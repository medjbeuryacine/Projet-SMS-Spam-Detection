name: ğŸš€ SpamShield CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # DÃ©clenchement manuel

env:
  PYTHON_VERSION: "3.10"
  HF_SPACE_NAME: "spamshield-sms-detection"

jobs:
  # ============================================================================
  # JOB 1: TESTS ET VALIDATION
  # ============================================================================
  test:
    name: ğŸ§ª Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Cache des dÃ©pendances
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ“‹ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8 black isort
        
    - name: ğŸ” Linting avec flake8
      run: |
        # VÃ©rifier la syntaxe Python
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # VÃ©rifier le style (warnings seulement)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: ğŸ¨ VÃ©rification du formatage
      run: |
        black --check --diff .
        isort --check-only --diff .
      continue-on-error: true  # Ne pas Ã©chouer si formatting pas parfait
      
    - name: ğŸ§ª Tests unitaires
      run: |
        # CrÃ©er des tests basiques
        python -c "
        import sys
        sys.path.append('.')

# Test d'import de base
try:
    from app import SpamShieldModels
    print('âœ… Import app.py rÃ©ussi')
except Exception as e:
    print(f'âŒ Erreur import app.py: {e}')
    sys.exit(1)

# Test d'import train_models
try:
    import train_models
    print('âœ… Import train_models.py rÃ©ussi')
except Exception as e:
    print(f'âš ï¸ Import train_models.py: {e}')

# Test de la structure Few-Shot
try:
    spam_shield = SpamShieldModels()
    result, conf = spam_shield.few_shot_predict('FREE PRIZE WIN NOW!')
    print(f'âœ… Test Few-Shot: {result} (confidence: {conf:.2f})')
    assert 'Spam' in result or 'Ham' in result, 'RÃ©sultat invalide'
    print('âœ… Tous les tests passent!')
except Exception as e:
    print(f'âŒ Erreur test Few-Shot: {e}')
    sys.exit(1)
"
        
    - name: ğŸ“Š Rapport de test
      run: |
        echo "## ğŸ“Š RÃ©sultats des Tests" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Syntaxe Python validÃ©e" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Imports fonctionnels" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Few-Shot model testÃ©" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 2: BUILD ET PRÃ‰PARATION
  # ============================================================================
  build:
    name: ğŸ”¨ Build et PrÃ©paration
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ—ï¸ PrÃ©-compilation des modÃ¨les
      run: |
        # TÃ©lÃ©charger les modÃ¨les sans entraÃ®ner (plus rapide)
        python -c "
import os
from transformers import AutoTokenizer, AutoModelForSequenceClassification

print('ğŸ“¥ TÃ©lÃ©chargement des modÃ¨les prÃ©-entraÃ®nÃ©s...')

# DistilBERT pour le fine-tuning
try:
    tokenizer = AutoTokenizer.from_pretrained('distilbert-base-uncased')
    model = AutoModelForSequenceClassification.from_pretrained('distilbert-base-uncased', num_labels=2)
    print('âœ… DistilBERT tÃ©lÃ©chargÃ©')
except Exception as e:
    print(f'âš ï¸ Erreur DistilBERT: {e}')

print('âœ… ModÃ¨les prÃªts pour le dÃ©ploiement')
"
        
    - name: ğŸ“ PrÃ©parer l'artefact de dÃ©ploiement
      run: |
        # CrÃ©er le dossier de dÃ©ploiement
        mkdir -p deploy
        
        # Copier les fichiers essentiels
        cp app.py deploy/
        cp requirements.txt deploy/
        cp README.md deploy/
        cp -r models deploy/ 2>/dev/null || echo "Pas de dossier models (normal)"
        
        # CrÃ©er un fichier de configuration pour HF Spaces
        sed -i '1i import os\nos.environ["TOKENIZERS_PARALLELISM"] = "false"' deploy/app.py
        sed -i 's/server_name="127.0.0.1"/server_name="0.0.0.0"/g' deploy/app.py
        
    - name: ğŸ“¤ Upload des artefacts
      uses: actions/upload-artifact@v4
      with:
        name: spamshield-deploy
        path: deploy/
        retention-days: 7

  # ============================================================================
  # JOB 3: DÃ‰PLOIEMENT SUR HUGGING FACE SPACES
  # ============================================================================
  deploy:
    name: ğŸš€ DÃ©ploiement Hugging Face Spaces
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ TÃ©lÃ©charger les artefacts
      uses: actions/download-artifact@v4
      with:
        name: spamshield-deploy
        path: deploy/
        
    - name: ğŸ”§ Setup Git et Hugging Face
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        pip install huggingface_hub
        
    - name: ğŸš€ DÃ©ploiement sur HF Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python -c "
import os
from huggingface_hub import HfApi
from pathlib import Path

# Configuration
token = os.environ.get('HF_TOKEN')
space_name = '${{ env.HF_SPACE_NAME }}'
username = '${{ github.actor }}'  # Votre nom d'utilisateur GitHub

if not token:
    print('âŒ HF_TOKEN non configurÃ© dans les secrets GitHub')
    print('ğŸ“ Configurez votre token HF dans Settings > Secrets > Actions')
    exit(1)

try:
    # Initialiser l'API
    api = HfApi(token=token)
    
    # CrÃ©er le Space (ou le mettre Ã  jour)
    space_id = f'{username}/{space_name}'
    
    try:
        # Essayer de crÃ©er le Space
        api.create_repo(
            repo_id=space_id,
            token=token,
            repo_type='space',
            space_sdk='gradio',
            private=False
        )
        print(f'âœ… Space crÃ©Ã©: https://huggingface.co/spaces/{space_id}')
    except Exception as e:
        print(f'âš ï¸ Space existe dÃ©jÃ  ou erreur: {e}')
    
    # Uploader les fichiers
    deploy_path = Path('deploy')
    for file_path in deploy_path.rglob('*'):
        if file_path.is_file():
            relative_path = file_path.relative_to(deploy_path)
            print(f'ğŸ“¤ Upload: {relative_path}')
            api.upload_file(
                path_or_fileobj=str(file_path),
                path_in_repo=str(relative_path),
                repo_id=space_id,
                repo_type='space',
                token=token
            )
    
    print(f'ğŸ‰ DÃ©ploiement rÃ©ussi!')
    print(f'ğŸŒ URL: https://huggingface.co/spaces/{space_id}')
    
except Exception as e:
    print(f'âŒ Erreur de dÃ©ploiement: {e}')
    exit(1)
"

  # ============================================================================
  # JOB 4: NOTIFICATION ET TESTS POST-DÃ‰PLOIEMENT
  # ============================================================================
  post-deploy:
    name: ğŸ“‹ Tests Post-DÃ©ploiement
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: â±ï¸ Attendre le dÃ©ploiement
      run: |
        echo "â±ï¸ Attente de 60 secondes pour le dÃ©ploiement..."
        sleep 60
        
    - name: ğŸŒ Test de l'endpoint
      run: |
        # Tester que l'application rÃ©pond
        SPACE_URL="https://huggingface.co/spaces/${{ github.actor }}/${{ env.HF_SPACE_NAME }}"
        
        echo "ğŸ” Test de l'URL: $SPACE_URL"
        
        # Test HTTP basique
        if curl -s -f "$SPACE_URL" > /dev/null; then
            echo "âœ… Application accessible"
        else
            echo "âš ï¸ Application pas encore accessible (normal aprÃ¨s dÃ©ploiement)"
        fi
        
    - name: ğŸ“Š RÃ©sumÃ© du dÃ©ploiement
      run: |
        echo "## ğŸš€ DÃ©ploiement TerminÃ©" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Informations" >> $GITHUB_STEP_SUMMARY
        echo "- **Space**: ${{ env.HF_SPACE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://huggingface.co/spaces/${{ github.actor }}/${{ env.HF_SPACE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branche**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Jobs ExÃ©cutÃ©s" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ§ª Tests et validation" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”¨ Build et prÃ©paration" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸš€ DÃ©ploiement HF Spaces" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“‹ Tests post-dÃ©ploiement" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‰ **SpamShield est maintenant en ligne !**" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 5: NETTOYAGE (Optionnel)
  # ============================================================================
  cleanup:
    name: ğŸ§¹ Nettoyage
    runs-on: ubuntu-latest
    needs: [test, build, deploy, post-deploy]
    if: always()
    
    steps:
    - name: ğŸ—‘ï¸ Nettoyage des artefacts anciens
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          
          // Garder seulement les 5 derniers artefacts
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner,
            repo,
            per_page: 100
          });
          
          const toDelete = artifacts.data.artifacts
            .filter(a => a.name === 'spamshield-deploy')
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(5); // Garder les 5 plus rÃ©cents
          
          for (const artifact of toDelete) {
            await github.rest.actions.deleteArtifact({
              owner,
              repo,
              artifact_id: artifact.id
            });
            console.log(`ğŸ—‘ï¸ SupprimÃ©: ${artifact.name} (${artifact.created_at})`);
          }