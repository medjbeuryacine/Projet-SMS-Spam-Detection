name: ğŸš€ SpamShield CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  HF_SPACE_NAME: "spamshield-sms-detection"

jobs:
  test:
    name: ğŸ§ª Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Cache des dÃ©pendances
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: ğŸ“‹ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest flake8 black isort
          
      - name: ğŸ” Linting avec flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
        
      - name: ğŸ¨ VÃ©rification du formatage
        run: |
          black --check --diff . || echo "Formatage Ã  amÃ©liorer"
          isort --check-only --diff . || echo "Imports Ã  organiser"
        continue-on-error: true
        
      - name: ğŸ§ª Tests unitaires
        run: |
          python -c '
          import sys
          sys.path.append(".")
          
          # Test import app.py seulement
          try:
              from app import SpamShieldModels
              print("âœ… Import app.py rÃ©ussi")
          except Exception as e:
              print(f"âŒ Erreur import app.py: {e}")
              sys.exit(1)
          
          # Test Few-Shot (pas besoin de modÃ¨les)
          try:
              spam_shield = SpamShieldModels()
              result, conf = spam_shield.few_shot_predict("FREE PRIZE WIN NOW!")
              print(f"âœ… Test Few-Shot: {result} (confidence: {conf:.2f})")
              assert "Spam" in result or "Ham" in result
              print("âœ… Tests passent!")
          except Exception as e:
              print(f"âŒ Erreur test Few-Shot: {e}")
              sys.exit(1)
          
          # Test que les fichiers modÃ¨les existent
          import os
          if os.path.exists("models/fine_tuned_model/model.safetensors"):
              print("âœ… ModÃ¨le fine-tuned trouvÃ©")
          else:
              print("âš ï¸ Pas de modÃ¨le fine-tuned (utilisera fallback)")
              
          if os.path.exists("models/model_info.pkl"):
              print("âœ… MÃ©tadonnÃ©es trouvÃ©es")
          else:
              print("âš ï¸ Pas de mÃ©tadonnÃ©es")
          '
          
      - name: ğŸ“Š Rapport de test
        run: |
          echo "## ğŸ“Š RÃ©sultats des Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Syntaxe Python validÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Imports fonctionnels" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Few-Shot model testÃ©" >> $GITHUB_STEP_SUMMARY

  build:
    name: ğŸ”¨ Build et PrÃ©paration
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ğŸ—ï¸ VÃ©rification des modÃ¨les
        run: |
            echo "ğŸ“¦ VÃ©rification des modÃ¨les existants..."
            if [ -d "models/" ]; then
                echo "âœ… Dossier models/ trouvÃ©"
                ls -la models/
            else
                echo "âš ï¸ Pas de dossier models/ (utilisation des fallbacks)"
            fi
            echo "âœ… ModÃ¨les prÃªts pour le dÃ©ploiement"
          
