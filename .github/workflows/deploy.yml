name: ğŸš€ SpamShield CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  HF_SPACE_NAME: "spamshield-sms-detection"

jobs:
  test:
    name: ğŸ§ª Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Cache des dÃ©pendances
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: ğŸ“‹ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest flake8 black isort
          
      - name: ğŸ” Linting avec flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
        
      - name: ğŸ¨ VÃ©rification du formatage
        run: |
          black --check --diff . || echo "Formatage Ã  amÃ©liorer"
          isort --check-only --diff . || echo "Imports Ã  organiser"
        continue-on-error: true
        
      - name: ğŸ§ª Tests unitaires
        run: |
          python -c '
          import sys
          sys.path.append(".")
          
          # Test import app.py seulement
          try:
              from app import SpamShieldModels
              print("âœ… Import app.py rÃ©ussi")
          except Exception as e:
              print(f"âŒ Erreur import app.py: {e}")
              sys.exit(1)
          
          # Test Few-Shot (pas besoin de modÃ¨les)
          try:
              spam_shield = SpamShieldModels()
              result, conf = spam_shield.few_shot_predict("FREE PRIZE WIN NOW!")
              print(f"âœ… Test Few-Shot: {result} (confidence: {conf:.2f})")
              assert "Spam" in result or "Ham" in result
              print("âœ… Tests passent!")
          except Exception as e:
              print(f"âŒ Erreur test Few-Shot: {e}")
              sys.exit(1)
          
          # Test que les fichiers modÃ¨les existent
          import os
          if os.path.exists("models/fine_tuned_model/model.safetensors"):
              print("âœ… ModÃ¨le fine-tuned trouvÃ©")
          else:
              print("âš ï¸ Pas de modÃ¨le fine-tuned (utilisera fallback)")
              
          if os.path.exists("models/model_info.pkl"):
              print("âœ… MÃ©tadonnÃ©es trouvÃ©es")
          else:
              print("âš ï¸ Pas de mÃ©tadonnÃ©es")
          '
          
      - name: ğŸ“Š Rapport de test
        run: |
          echo "## ğŸ“Š RÃ©sultats des Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Syntaxe Python validÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Imports fonctionnels" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Few-Shot model testÃ©" >> $GITHUB_STEP_SUMMARY

  build:
    name: ğŸ”¨ Build et PrÃ©paration
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ğŸ—ï¸ VÃ©rification des modÃ¨les
        run: |
            echo "ğŸ“¦ VÃ©rification des modÃ¨les existants..."
            if [ -d "models/" ]; then
                echo "âœ… Dossier models/ trouvÃ©"
                ls -la models/
            else
                echo "âš ï¸ Pas de dossier models/ (utilisation des fallbacks)"
            fi
            echo "âœ… ModÃ¨les prÃªts pour le dÃ©ploiement"
          
      - name: ğŸ“ PrÃ©parer l'artefact de dÃ©ploiement
        run: |
          mkdir -p deploy
          cp app.py deploy/
          cp requirements.txt deploy/
          cp README.md deploy/
          cp -r models deploy/ 2>/dev/null || echo "Pas de dossier models (normal)"
          
          # Optimiser pour HF Spaces
          cat > deploy/app_temp.py << 'EOF'
          import os
          os.environ["TOKENIZERS_PARALLELISM"] = "false"
          EOF
          cat deploy/app_temp.py deploy/app.py > deploy/app_final.py
          mv deploy/app_final.py deploy/app.py
          rm deploy/app_temp.py
          
          # Modifier server config pour HF Spaces
          sed -i 's/server_name="127.0.0.1"/server_name="0.0.0.0"/g' deploy/app.py
          
      - name: ğŸ“¤ Upload des artefacts
        uses: actions/upload-artifact@v4
        with:
          name: spamshield-deploy
          path: deploy/
          retention-days: 7

  deploy:
    name: ğŸš€ DÃ©ploiement Hugging Face Spaces
    runs-on: ubuntu-latest
    needs: [test, build]
    if: false
    
    steps:
      - name: ğŸ“¥ TÃ©lÃ©charger les artefacts
        uses: actions/download-artifact@v4
        with:
          name: spamshield-deploy
          path: deploy/
          
      - name: ğŸ”§ Setup Git et Hugging Face
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          pip install huggingface_hub
          
      - name: ğŸš€ DÃ©ploiement sur HF Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c '
          import os
          from huggingface_hub import HfApi
          from pathlib import Path
          
          # Configuration
          token = os.environ.get("HF_TOKEN")
          space_name = "${{ env.HF_SPACE_NAME }}"
          username = "${{ github.actor }}"
          
          if not token:
              print("âŒ HF_TOKEN non configurÃ© dans les secrets GitHub")
              print("ğŸ“ Configurez votre token HF dans Settings > Secrets > Actions")
              exit(1)
          
          try:
              # Initialiser API
              api = HfApi(token=token)
              space_id = f"{username}/{space_name}"
              
              # CrÃ©er le Space
              try:
                  api.create_repo(
                      repo_id=space_id,
                      token=token,
                      repo_type="space",
                      space_sdk="gradio",
                      private=False
                  )
                  print(f"âœ… Space crÃ©Ã©: https://huggingface.co/spaces/{space_id}")
              except Exception as e:
                  print(f"âš ï¸ Space existe dÃ©jÃ  ou erreur: {e}")
              
              # Upload fichiers
              deploy_path = Path("deploy")
              for file_path in deploy_path.rglob("*"):
                  if file_path.is_file():
                      relative_path = file_path.relative_to(deploy_path)
                      print(f"ğŸ“¤ Upload: {relative_path}")
                      api.upload_file(
                          path_or_fileobj=str(file_path),
                          path_in_repo=str(relative_path),
                          repo_id=space_id,
                          repo_type="space",
                          token=token
                      )
              
              print(f"ğŸ‰ DÃ©ploiement rÃ©ussi!")
              print(f"ğŸŒ URL: https://huggingface.co/spaces/{space_id}")
              
          except Exception as e:
              print(f"âŒ Erreur de dÃ©ploiement: {e}")
              exit(1)
          '

  post-deploy:
    name: ğŸ“‹ Tests Post-DÃ©ploiement
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: â±ï¸ Attendre le dÃ©ploiement
        run: |
          echo "â±ï¸ Attente de 60 secondes pour le dÃ©ploiement..."
          sleep 60
          
      - name: ğŸŒ Test de l'endpoint
        run: |
          SPACE_URL="https://huggingface.co/spaces/${{ github.actor }}/${{ env.HF_SPACE_NAME }}"
          echo "ğŸ” Test de l'URL: $SPACE_URL"
          
          if curl -s -f "$SPACE_URL" > /dev/null; then
              echo "âœ… Application accessible"
          else
              echo "âš ï¸ Application pas encore accessible (normal aprÃ¨s dÃ©ploiement)"
          fi
          
      - name: ğŸ“Š RÃ©sumÃ© du dÃ©ploiement
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸš€ DÃ©ploiement TerminÃ©
          
          ### ğŸ“‹ Informations
          - **Space**: ${{ env.HF_SPACE_NAME }}
          - **URL**: https://huggingface.co/spaces/${{ github.actor }}/${{ env.HF_SPACE_NAME }}
          - **Commit**: ${{ github.sha }}
          - **Branche**: ${{ github.ref_name }}
          
          ### âœ… Jobs ExÃ©cutÃ©s
          - ğŸ§ª Tests et validation
          - ğŸ”¨ Build et prÃ©paration
          - ğŸš€ DÃ©ploiement HF Spaces
          - ğŸ“‹ Tests post-dÃ©ploiement
          
          ğŸ‰ **SpamShield est maintenant en ligne !**
          EOF

  cleanup:
    name: ğŸ§¹ Nettoyage
    runs-on: ubuntu-latest
    needs: [test, build, deploy, post-deploy]
    if: always()
    
    steps:
      - name: ğŸ—‘ï¸ Nettoyage des artefacts anciens
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            const toDelete = artifacts.data.artifacts
              .filter(a => a.name === 'spamshield-deploy')
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(5);
            
            for (const artifact of toDelete) {
              await github.rest.actions.deleteArtifact({
                owner,
                repo,
                artifact_id: artifact.id
              });
              console.log(`ğŸ—‘ï¸ SupprimÃ©: ${artifact.name} (${artifact.created_at})`);
            }